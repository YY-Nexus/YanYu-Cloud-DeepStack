# 环境变量配置文档

## 📋 概述

本文档详细说明了言語云³ 深度堆栈全栈智创引擎所需的所有环境变量配置。

## 🚀 快速配置

### 最小配置（开发环境）

\`\`\`bash
# 复制示例文件
cp .env.example .env.local

# 编辑配置文件
nano .env.local
\`\`\`

**最小必需配置：**
\`\`\`env
NODE_ENV=development
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXTAUTH_SECRET=your-secret-key-here
NEXT_PUBLIC_OLLAMA_URL=http://localhost:11434
\`\`\`

### 生产环境配置

**必需配置项：**
\`\`\`env
NODE_ENV=production
NEXT_PUBLIC_APP_URL=https://your-domain.com
NEXTAUTH_SECRET=your-production-secret-key
KV_REST_API_URL=your-redis-url
KV_REST_API_TOKEN=your-redis-token
\`\`\`

## 📚 配置分类详解

### 1. 基础应用配置

| 变量名 | 类型 | 必需 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `NODE_ENV` | string | ✅ | development | 应用运行环境 |
| `NEXT_PUBLIC_APP_URL` | string | ✅ | http://localhost:3000 | 应用访问地址 |
| `NEXT_PUBLIC_APP_NAME` | string | ❌ | YanYu Cloud³ DeepStack | 应用名称 |
| `NEXT_PUBLIC_APP_VERSION` | string | ❌ | 1.0.0 | 应用版本 |

### 2. AI 服务配置

| 变量名 | 类型 | 必需 | 说明 |
|--------|------|------|------|
| `NEXT_PUBLIC_OLLAMA_URL` | string | 🔶 | Ollama 服务地址 |
| `OPENAI_API_KEY` | string | ❌ | OpenAI API 密钥 |
| `XAI_API_KEY` | string | ❌ | xAI (Grok) API 密钥 |
| `GROQ_API_KEY` | string | ❌ | Groq API 密钥 |
| `FAL_KEY` | string | ❌ | Fal AI API 密钥 |

**配置说明：**
- 🔶 表示推荐配置，不配置将使用模拟数据
- 至少配置一个 AI 服务以获得完整功能

### 3. 外部 API 服务

| 服务类型 | 变量名 | 获取方式 | 说明 |
|----------|--------|----------|------|
| 天气服务 | `OPENWEATHER_API_KEY` | [OpenWeatherMap](https://openweathermap.org/api) | 免费额度：1000次/天 |
| 新闻服务 | `NEWS_API_KEY` | [NewsAPI](https://newsapi.org/) | 免费额度：1000次/天 |
| IP查询 | `IPINFO_TOKEN` | [IPInfo](https://ipinfo.io/) | 免费额度：50000次/月 |
| 股票数据 | `ALPHA_VANTAGE_API_KEY` | [Alpha Vantage](https://www.alphavantage.co/) | 免费额度：5次/分钟 |
| 地理编码 | `GOOGLE_MAPS_API_KEY` | [Google Cloud](https://cloud.google.com/maps-platform) | 按使用量计费 |
| 翻译服务 | `GOOGLE_TRANSLATE_API_KEY` | [Google Cloud](https://cloud.google.com/translate) | 按使用量计费 |

### 4. 数据库和缓存

| 变量名 | 服务商 | 必需 | 说明 |
|--------|--------|------|------|
| `KV_REST_API_URL` | Upstash | 🔶 | Redis 缓存服务地址 |
| `KV_REST_API_TOKEN` | Upstash | 🔶 | Redis 缓存服务令牌 |
| `DATABASE_URL` | Neon/Supabase | ❌ | PostgreSQL 数据库连接 |
| `NEXT_PUBLIC_SUPABASE_URL` | Supabase | ❌ | Supabase 项目地址 |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Supabase | ❌ | Supabase 匿名密钥 |

**Upstash Redis 配置步骤：**
1. 访问 [Upstash Console](https://console.upstash.com/)
2. 创建新的 Redis 数据库
3. 复制 REST API URL 和 Token
4. 配置到环境变量中

### 5. 认证和安全

| 变量名 | 必需 | 生成方式 | 说明 |
|--------|------|----------|------|
| `NEXTAUTH_SECRET` | ✅ | `openssl rand -base64 32` | NextAuth.js 密钥 |
| `JWT_SECRET` | ❌ | `openssl rand -base64 32` | JWT 签名密钥 |
| `API_KEY_SALT` | ❌ | `openssl rand -base64 16` | API 密钥盐值 |

**OAuth 配置：**
\`\`\`env
# GitHub OAuth
GITHUB_CLIENT_ID=your_github_client_id
GITHUB_CLIENT_SECRET=your_github_client_secret

# Google OAuth
GOOGLE_CLIENT_ID=your_google_client_id
GOOGLE_CLIENT_SECRET=your_google_client_secret
\`\`\`

### 6. 监控和分析

| 服务 | 变量名 | 获取方式 |
|------|--------|----------|
| Sentry | `SENTRY_DSN` | [Sentry.io](https://sentry.io/) |
| Google Analytics | `NEXT_PUBLIC_GA_MEASUREMENT_ID` | [Google Analytics](https://analytics.google.com/) |
| Vercel Analytics | `NEXT_PUBLIC_VERCEL_ANALYTICS_ID` | [Vercel Dashboard](https://vercel.com/analytics) |
| PostHog | `NEXT_PUBLIC_POSTHOG_KEY` | [PostHog](https://posthog.com/) |

## 🔧 配置工具

### 环境变量验证脚本

\`\`\`bash
#!/bin/bash
# scripts/validate-env.sh

echo "🔍 验证环境变量配置..."

# 检查必需变量
required_vars=(
  "NODE_ENV"
  "NEXT_PUBLIC_APP_URL"
  "NEXTAUTH_SECRET"
)

for var in "${required_vars[@]}"; do
  if [ -z "${!var}" ]; then
    echo "❌ 缺少必需环境变量: $var"
    exit 1
  else
    echo "✅ $var 已配置"
  fi
done

echo "🎉 环境变量验证通过！"
\`\`\`

### 配置生成器

\`\`\`javascript
// scripts/generate-env.js
const crypto = require('crypto');
const fs = require('fs');

function generateSecret(length = 32) {
  return crypto.randomBytes(length).toString('base64');
}

const envConfig = `
# 自动生成的环境变量配置
NODE_ENV=development
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXTAUTH_SECRET=${generateSecret()}
JWT_SECRET=${generateSecret()}
API_KEY_SALT=${generateSecret(16)}

# 请手动配置以下变量
# NEXT_PUBLIC_OLLAMA_URL=http://localhost:11434
# OPENAI_API_KEY=your_openai_key_here
`;

fs.writeFileSync('.env.local', envConfig.trim());
console.log('✅ 环境变量配置文件已生成: .env.local');
\`\`\`

## 🚀 部署配置

### Vercel 部署

1. **在 Vercel Dashboard 中配置环境变量**
2. **生产环境必需变量：**
   \`\`\`
   NODE_ENV=production
   NEXT_PUBLIC_APP_URL=https://your-domain.vercel.app
   NEXTAUTH_SECRET=your-production-secret
   \`\`\`

### Docker 部署

\`\`\`dockerfile
# Dockerfile
FROM node:18-alpine

# 设置环境变量
ENV NODE_ENV=production
ENV NEXT_PUBLIC_APP_URL=http://localhost:3000

# 复制环境变量文件
COPY .env.production .env.local

# ... 其他构建步骤
\`\`\`

### 环境变量管理工具

**推荐工具：**
- [Doppler](https://doppler.com/) - 企业级密钥管理
- [Infisical](https://infisical.com/) - 开源密钥管理
- [AWS Secrets Manager](https://aws.amazon.com/secrets-manager/) - AWS 密钥管理
- [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) - Azure 密钥管理

## 🔒 安全最佳实践

### 1. 密钥管理
- ✅ 使用强随机密钥
- ✅ 定期轮换 API 密钥
- ✅ 不在代码中硬编码密钥
- ✅ 使用环境变量管理工具

### 2. 权限控制
- ✅ 最小权限原则
- ✅ 分离开发和生产环境
- ✅ 定期审计 API 使用情况

### 3. 监控和告警
- ✅ 配置 API 使用量监控
- ✅ 设置异常访问告警
- ✅ 记录敏感操作日志

## 🐛 常见问题

### Q: Ollama 连接失败
**A:** 检查以下配置：
\`\`\`bash
# 确保 Ollama 服务正在运行
ollama serve

# 检查端口是否正确
NEXT_PUBLIC_OLLAMA_URL=http://localhost:11434

# 检查防火墙设置
\`\`\`

### Q: 外部 API 返回 401 错误
**A:** 检查 API 密钥配置：
\`\`\`bash
# 验证密钥格式
echo $OPENAI_API_KEY | wc -c

# 检查密钥权限
curl -H "Authorization: Bearer $OPENAI_API_KEY" https://api.openai.com/v1/models
\`\`\`

### Q: 缓存服务连接失败
**A:** 验证 Redis 配置：
\`\`\`bash
# 测试连接
curl -X GET "$KV_REST_API_URL/ping" \
  -H "Authorization: Bearer $KV_REST_API_TOKEN"
\`\`\`

### Q: 生产环境配置不生效
**A:** 检查环境变量优先级：
1. `.env.local` (最高优先级)
2. `.env.production`
3. `.env`
4. `.env.example` (最低优先级)

## 📞 技术支持

如果在配置过程中遇到问题，请：

1. **查看日志输出**
2. **检查环境变量拼写**
3. **验证 API 密钥有效性**
4. **提交 Issue** 到项目仓库

---

**配置完成后，请运行 `npm run dev` 启动开发服务器进行测试！** 🚀
